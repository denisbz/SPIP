#HTTP_HEADER{"Cache-Control: no-store, no-cache, must-revalidate"}
#HTTP_HEADER{"Pragma: no-cache"}

[(#ENV{echec_cookie})
<fieldset class="reponse_formulaire">
<legend><:avis_erreur_cookie:></legend>
<p><:login_cookie_oblige:></p>
<p><:login_cookie_accepte:></p>
</fieldset>]

[(#ENV{echec_visiteur})
<fieldset class="reponse_formulaire">
<legend><:avis_erreur_visiteur:></legend>
<p><:texte_erreur_visiteur:></p>
</fieldset>]

	<script type="text/javascript" src="#EVAL{_DIR_JAVASCRIPT}md5.js"> </script>
	<form id="login[_(#ENV{login})]"
		action="[(#ENV{action2})]"
		method="post"[(#ENV{source}|=={spip}|?{' ',''})
		onsubmit='if (this.session_password.value) {
			this.session_password_md5.value = calcMD5("[(#ENV{alea_actuel})]" + this.session_password.value);
			this.next_session_password_md5.value = calcMD5("[(#ENV{alea_futur})]" + this.session_password.value);
			this.session_password.value = "";
			return true;
			}']>
	<fieldset>
	<legend><:form_forum_identifiants:></legend>
		[<p class="reponse_formulaire">(#ENV*{erreur})</p>]

		<span id="spip_logo_auteur">[(#INCLURE{fond=formulaires/logo_auteur}{id_auteur}|inserer_attribut{alt,#ENV{login_alt}})]</span>

		[<p><label for="var_login"><:login_login2:></label>(#ENV{login}|?{'',' '})<br />
		<input type="text" class="forml" id="var_login" name="var_login" value="" size="40" /></p>]
		
[


<input type="hidden" name="session_login_hidden" value="(#ENV{login})" />
<p id='login_securise' style='display: none;'><:login_login:>&nbsp;<strong>[(#ENV{login_alt})]</strong><br />&#91;<a href='[(#ENV{action2}
	|parametre_url{cookie_admin,non}
	|parametre_url{url,#ENV*{url}}
	|parametre_url{retour,#ENV*{self}})]'><:login_autre_identifiant:></a>&#93;</p>
<script type="text/javascript"><!--
if (l=document.getElementById('login_securise'))	l.style.display='';
//--></script>
<noscript>
	<div id='login_non_securise'>
	<p class="reponse_formulaire"><:login_non_securise:> <a href="[(#ENV{action})]"><:login_recharger:></a>.</p>
	<p><label for="session_login"><:login_login2:></label><br />
	<input type="text" class="forml" name="session_login" id="session_login"[ value="(#ENV{login})"] size="40" /></p>
	</div>
</noscript>
]
	[(#ENV{login}|?{'',' '})<div id='pass_ajax' style='display: none;'>]
	<p><label[ for="var_login_(#ENV{login})"]><:login_pass2:></label><br />
	<input type="password" class="forml" name="session_password"[ id="var_login_(#ENV{login})"] value="" size="20" /><br />
	&#91;<a href="#URL_PAGE{spip_pass}" target="spip_pass" onclick="javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=330'); return false;"><:login_motpasseoublie:></a>&#93;
	</p>

[(#ENV{rester_connecte})
	<p><input type="checkbox" name="session_remember" id="session_remember[_(#ENV{login})]" value="oui"[(#ENV*{prefs}|filtre_rester_connecte)checked="checked"]
	class="intact" onchange="this.className='';" />
	<label for="session_remember[_(#ENV{login})]"><:login_rester_identifie:></label></p>
]
	[(#ENV{login}|?{'',' '})</div>]
	<input type="hidden" name="session_password_md5" value="" />
	<input type="hidden" name="next_session_password_md5" value="" />
	<input type="hidden" name="essai_login" value="oui" />
	<input type="hidden" name="url" value="[(#ENV{url})]" />
	<input type="hidden" name="url_echec" value="[(#SELF)]" />
	<p class="spip_bouton"><input type="submit" value="<:bouton_valider:>" /></p>
	</fieldset>
	</form>
	
<script type="text/javascript"><!--
if (l=document.getElementById('var_login[_(#ENV{login})]')) l.focus();
--></script>[
	<form action="(#ENV{auth_http})" method="get">[
	(#ENV{auth_http}|form_hidden)
	]
	<fieldset>
	<legend><:login_sans_cookiie:></legend>
	<div><:login_preferez_refuser:>
	<input type="hidden" name="essai_auth_http" value="oui"/>
	[<input type="hidden" name="url" value="(#ENV{url})"/>]
	<p class="spip_bouton"><input type="submit" value="<:login_sans_cookiie:>"/></p></div>
	</fieldset>
	</form>
]
[(#ENV{login}|?{'',' '})
<script type='text/javascript'>
var alea_actuel;
var alea_futur;
var login;
var informe_auteur_en_cours = false;
function informe_auteur(c){
	eval('c = '+c); // JSON
	if (c) {
		alea_actuel = c.alea_actuel;
		alea_futur = c.alea_futur;
		$('input#session_login_hidden').attr('value',c.login);
		// indiquer le cnx si on n'y a pas touche
		$('input#session_remember.intact')
		.attr('checked',c.cnx=='1'?'checked':'');
		$('#spip_logo_auteur').html(c.logo);
	} else {
		$('#spip_logo_auteur').html('');
	}
	informe_auteur_en_cours = false;
}
function calcule_md5_pass(pass){
	$('input\u005b@name=session_password\u005d').attr('value','');
	$('form#login').attr('action','#ENV{pose_cookie}');
	$('input\u005b@name=session_password_md5\u005d').attr('value',calcMD5(alea_actuel + pass));
	$('input\u005b@name=next_session_password_md5\u005d').attr('value',calcMD5(alea_futur + pass));
}
$('form#login #pass_ajax').show().after('<input type="hidden" name="session_login_hidden" id="session_login_hidden" value="" />');
$('#var_login').blur(function(){
	if (login!=$(this).attr('value')) {
		login = $(this).attr('value');
		informe_auteur_en_cours = true;
		$.get('#URL_ACTION{informer_auteur}',{var_login:$(this).attr('value')},informe_auteur);
	}
});
$('form#login').submit(function(){
	pass = $('input\u005b@name=session_password\u005d').attr('value');
	// ne jamais laisser le pass circuler en clair
	if (pass) {
		if (alea_actuel)
			// on a l'alea, on peut lancer le submit apres avoir hashe le pass
			calcule_md5_pass(pass);
		else {
			// on a pas encore l'alea de l'auteur
			// retrouver les alea de l'auteur qui ne sont pas encore arrives (remplissage auto des champs par le navigateur) !
			
			// si l'information est en cours, retenter sa chance
			if (informe_auteur_en_cours) {
				setTimeout(function(){$('form#login').submit();},300);
				return false;
			}

			// sinon lancer une demande
			informe_auteur_en_cours = true;
			$.get('#URL_ACTION{informer_auteur}',{var_login:$('#var_login').attr('value')},function(c) {
				informe_auteur(c);
				// le formulaire sera soumis apres reception des info auteur
				$('form#login').submit();
			});
			// ou dans un delai maxi de 5s (pour eviter le blocage a cette etape)
			// mais sans le pass, ce qui fait retomber sur le scenario de repli du login en 2 passes
			setTimeout(function(){
				$('input\u005b@name=session_password\u005d').attr('value','');
				$('form#login').submit();
			},3000);
			return false;
		}
	}
});
</script>
]
